import scrapy
from scrapy import Request
import csv
import os

class ConsultationItem(scrapy.Item):
    page_number = scrapy.Field()
    Startdatum_consultatie = scrapy.Field()
    Einddatum_consultatie = scrapy.Field()
    Status = scrapy.Field()
    Type_consultatie = scrapy.Field()
    Organisatie = scrapy.Field()
    Keten_ID = scrapy.Field()
    Onderwerpen = scrapy.Field()
    Beleidskompas = scrapy.Field() # TODO
    IAK = scrapy.Field() # TODO

class PageSpider(scrapy.Spider):
    name = "pagespider"
    base_folder = 'data'  # Main folder to store all data
    page_number = 1

    def start_requests(self):
        # Replace 'links.csv' with your CSV file name
        with open('links.csv', 'r') as file:
            reader = csv.DictReader(file)
            for index, row in enumerate(reader, start=1):
                url = row['url']
                yield scrapy.Request(url, meta={'page_number': index})

    
    def parse(self, response):
        page_number = response.meta['page_number']  # Retrieve the current page number from meta
        item = ConsultationItem(page_number=page_number)
        rows = response.xpath('//table[contains(@class, "table__data-overview")]/tbody/tr')
        for row in rows:
            header = row.xpath('th/text()').get().strip().replace(' ', '_').replace('.', '')
            value = row.xpath('td//text()').get().strip()
            item[header] = value

        item['Beleidskompas'] = False
        item['IAK'] = False
        # Search for 'beleidskompas' in list items
        list_items = response.xpath('//ul[@id="113"]/li')
        for li in list_items:
            # Extract text from each list item and perform a case-insensitive search
            text = li.xpath('.//text()').getall()
            text = ' '.join(text)  # Combine list elements into a single string
            if 'beleidskompas' in text.lower():  # Case-insensitive check
                item['Beleidskompas'] = True
            if 'iak' in text.lower():
                item['IAK'] = True
    
        yield item
